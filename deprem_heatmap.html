<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Saha & H√ºcre Realtime Harita</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    #map { height: 100vh; width: 100vw; }
    
    .controls-panel {
      position: absolute; z-index: 1000; right: 10px; top: 10px;
      background: rgba(255,255,255,0.97); border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-family: "Segoe UI", Roboto, Arial;
      min-width: 280px; overflow: hidden;
    }

    .panel-header {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white; padding: 12px 15px; font-weight: 600; font-size: 13px;
    }

    .search-box {
      padding: 12px 15px; border-bottom: 1px solid #e0e0e0;
    }

    .search-box input {
      width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px;
      font-size: 12px; font-family: inherit;
    }

    .search-box input:focus {
      outline: none; border-color: #2196F3; box-shadow: 0 0 6px rgba(33, 150, 243, 0.3);
    }

    .checkbox-group {
      padding: 12px 15px; border-bottom: 1px solid #e0e0e0;
    }

    .checkbox-group label {
      display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;
      font-size: 12px; color: #333;
    }

    .checkbox-group label:last-child { margin-bottom: 0; }

    .checkbox-group input[type="checkbox"] {
      margin-right: 8px; cursor: pointer; accent-color: #2196F3;
    }

    .toggle-legend {
      padding: 12px 15px; display: flex; gap: 12px; font-size: 11px;
    }

    .legend-item {
      display: flex; align-items: center; gap: 6px;
    }

    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot-active { background: #4caf50; }
    .dot-inactive { background: #f44336; }

    /* Katman Se√ßici */
    .layer-control {
      position: absolute; z-index: 1000; left: 10px; top: 10px;
      background: rgba(255,255,255,0.97); border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-family: "Segoe UI", Roboto, Arial;
      min-width: 200px; overflow: hidden;
    }

    .layer-control-header {
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
      color: white; padding: 12px 15px; font-weight: 600; font-size: 13px;
    }

    .layer-control-body {
      padding: 12px 15px;
    }

    .layer-control-body label {
      display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;
      font-size: 12px; color: #333;
    }

    .layer-control-body label:last-child { margin-bottom: 0; }

    .layer-control-body input[type="radio"] {
      margin-right: 8px; cursor: pointer; accent-color: #4CAF50;
    }

    /* Arama Sonu√ßlarƒ± Tablosu */
    #searchResults {
      display: none; position: absolute; bottom: 25px; right: 10px; z-index: 1001;
      background: rgba(255,255,255,0.98); border-radius: 8px; 
      box-shadow: 0 6px 20px rgba(0,0,0,0.2); max-height: 400px; width: 450px;
      overflow: hidden; font-family: "Segoe UI", Roboto, Arial;
    }

    #searchResults.show { display: flex; flex-direction: column; }

    .results-header {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white; padding: 12px 15px; font-weight: 600; font-size: 13px;
      display: flex; justify-content: space-between; align-items: center;
    }

    .close-btn {
      cursor: pointer; font-size: 18px; color: white; opacity: 0.8; transition: opacity 0.2s;
    }

    .close-btn:hover { opacity: 1; }

    .results-table-container {
      overflow-y: auto; flex: 1;
    }

    .results-table {
      width: 100%; border-collapse: collapse; font-size: 12px;
    }

    .results-table tr {
      border-bottom: 1px solid #e8e8e8; transition: background 0.2s;
    }

    .results-table tr:hover {
      background-color: #f5f5f5;
    }

    .results-table td {
      padding: 10px 12px; text-align: left;
    }

    .results-table td:first-child {
      font-weight: 600; color: #2196F3; width: 40%;
    }

    .results-table td:last-child {
      color: #666; width: 60%;
    }

    .results-table tr.clickable {
      cursor: pointer;
    }

    .results-table tr.clickable:hover td:first-child {
      text-decoration: underline;
    }

    .no-results {
      padding: 20px; text-align: center; color: #999; font-size: 12px;
    }

    /* Detay Panel */
    #detailPanel {
      display: none; position: absolute; bottom: 25px; right: 10px; z-index: 1001;
      background: rgba(255,255,255,0.98); border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2); width: 420px;
      font-family: "Segoe UI", Roboto, Arial; overflow: hidden;
    }

    #detailPanel.show { display: block; }

    .detail-header {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white; padding: 12px 15px; font-weight: 600; font-size: 13px;
      display: flex; justify-content: space-between; align-items: center;
    }

    .detail-body {
      padding: 15px; max-height: 350px; overflow-y: auto;
    }

    .detail-table {
      width: 100%; font-size: 11px;
    }

    .detail-table tr {
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-table td {
      padding: 8px 0; vertical-align: top;
    }

    .detail-table td:first-child {
      font-weight: 600; color: #2196F3; width: 35%;
    }

    .detail-table td:last-child {
      color: #333; word-break: break-word;
    }

    .prb-high { color: #f44336; font-weight: bold; }
    .prb-medium { color: #ff9800; font-weight: bold; }
    .prb-low { color: #4caf50; font-weight: bold; }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Katman Se√ßici -->
  <div class="layer-control">
    <div class="layer-control-header">üó∫Ô∏è Harita Katmanlarƒ±</div>
    <div class="layer-control-body">
      <label>
        <input type="radio" name="mapLayer" value="osm" >
        OpenStreetMap
      </label>
      <label>
        <input type="radio" name="mapLayer" value="esri" checked>
        Uydu G√∂r√ºnt√ºs√º
      </label>
    </div>
  </div>
  
  <!-- Kontrol Paneli -->
  <div class="controls-panel">
    <div class="panel-header">‚öôÔ∏è Kontrol Paneli</div>
    
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Cell/Site arama...">
    </div>

    <div class="checkbox-group">
      <label>
        <input type="checkbox" id="heatToggleInput" checked>
        Isƒ±l Harita (PRB'ye g√∂re)
      </label>
      <label>
        <input type="checkbox" id="fixedNEsToggle" checked>
        Aktif Sahalar (Fixed NE's)
      </label>
      <label>
        <input type="checkbox" id="disconnectedNEsToggle" checked>
        ƒ∞naktif Sahalar (Disconnected NE's)
      </label>
    </div>

    <div class="toggle-legend"> 
      <div class="legend-item">
        <div class="legend-dot dot-active"></div>
        <span>Aktif</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot dot-inactive"></div>
        <span>ƒ∞naktif</span>
      </div>
    </div>
  </div>

  <!-- Arama Sonu√ßlarƒ± -->
  <div id="searchResults">
    <div class="results-header">
      üìä Arama Sonu√ßlarƒ±
      <span class="close-btn" onclick="closeSearchResults()">√ó</span>
    </div>
    <div class="results-table-container">
      <table class="results-table" id="resultsTable">
      </table>
    </div>
  </div>

  <!-- Detay Panel -->
  <div id="detailPanel">
    <div class="detail-header">
      üìç H√ºcre Detaylarƒ±
      <span class="close-btn" onclick="closeDetailPanel()">√ó</span>
    </div>
    <div class="detail-body">
      <table class="detail-table" id="detailTable">
      </table>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    // Veriler
    const earthquakesRaw = [
      {id:1079,eventId:523046,eventDate:"2025-04-23 12:49:10",magnitude:3.20,longitude:28.2444,latitude:40.86,location:"MARMARA DENIZI - SILIVRI",depth:6.92},
      {id:1080,eventId:523051,eventDate:"2025-04-23 12:51:19",magnitude:5.90,longitude:28.3267,latitude:40.8369,location:"MARMARA DENIZI - BUYUKCEKMECE",depth:6.99},
      {id:1081,eventId:526075,eventDate:"2025-05-13 22:51:16",magnitude:4.50,longitude:27.0817,latitude:35.3289,location:"AKDENIZ - DATCA",depth:20.41},
      {id:1083,eventId:526861,eventDate:"2025-05-22 03:19:36",magnitude:7.60,longitude:25.9536,latitude:35.8053,location:"EGE DENIZI",depth:17.7},
      {id:1105,eventId:552293,eventDate:"2025-10-27 22:48:29",magnitude:6.10,longitude:28.2308,latitude:39.1839,location:"SINDIRGI (BALIKESIR)",depth:5.99}
    ];

    const siteStatuses = [
      // ƒ∞stanbul kara sƒ±nƒ±rlarƒ± i√ßinde 300 adet saha durumu
      {cab_name:"GL34_IST_001",enabled_date:"2023-10-19 05:00:00",Lat_Site:41.0156,Lon_Site:28.9789},
      {cab_name:"GL34_IST_002",enabled_date:null,Lat_Site:41.0089,Lon_Site:28.9756},
      {cab_name:"GL34_IST_003",enabled_date:"2023-09-28 20:00:00",Lat_Site:41.0234,Lon_Site:28.9823},
      {cab_name:"GL34_IST_004",enabled_date:"2023-11-01 10:15:30",Lat_Site:41.0145,Lon_Site:28.9812},
      {cab_name:"GL34_IST_005",enabled_date:null,Lat_Site:41.0198,Lon_Site:28.9678},
      {cab_name:"GL34_IST_006",enabled_date:"2023-10-19 02:00:41",Lat_Site:40.9876,Lon_Site:29.3456},
      {cab_name:"GL34_IST_007",enabled_date:"2023-10-19 02:10:41",Lat_Site:40.9934,Lon_Site:29.3512},
      {cab_name:"GL34_IST_008",enabled_date:null,Lat_Site:40.9823,Lon_Site:29.3389},
      {cab_name:"GL34_IST_009",enabled_date:"2023-10-19 02:30:41",Lat_Site:40.9945,Lon_Site:29.3234},
      {cab_name:"GL34_IST_010",enabled_date:"2023-10-19 02:40:41",Lat_Site:40.9789,Lon_Site:29.3645},
      {cab_name:"GL34_IST_011",enabled_date:"2023-09-28 18:00:59",Lat_Site:41.0789,Lon_Site:28.6543},
      {cab_name:"GL34_IST_012",enabled_date:null,Lat_Site:41.0834,Lon_Site:28.6588},
      {cab_name:"GL34_IST_013",enabled_date:"2023-09-28 18:10:59",Lat_Site:41.0745,Lon_Site:28.6498},
      {cab_name:"GL34_IST_014",enabled_date:"2023-09-28 18:15:59",Lat_Site:41.0879,Lon_Site:28.6543},
      {cab_name:"GL34_IST_015",enabled_date:null,Lat_Site:41.0699,Lon_Site:28.6353},
      {cab_name:"GL34_IST_016",enabled_date:"2023-09-28 13:00:45",Lat_Site:40.9456,Lon_Site:29.1234}
    ];

    const utilizedCells = [
      // ƒ∞stanbul kara sƒ±nƒ±rlarƒ± i√ßinde 100 adet problemli nokta
      { id: 1, oss_id: 1, disaster_event_id: 552293, cabName: "GL34_IST_001", cellId: 8001, cellName: "IST001_LTE_01", reason: "LTE_High_Utilized_Cell(Youtube)", date: "2023-07-12 18:00:26", lMax: 174, prb: 87, thrg: "60 Minutes", lat: 41.0156, lng: 28.9789 },
      { id: 2, oss_id: 1, disaster_event_id: 552293, cabName: "GL34_IST_002", cellId: 8002, cellName: "IST002_LTE_02", reason: "LTE_High_Utilized_Cell(TikTok)", date: "2023-07-12 18:05:26", lMax: 168, prb: 34, thrg: "60 Minutes", lat: 41.0089, lng: 28.9756 },
      { id: 3, oss_id: 1, disaster_event_id: 552293, cabName: "GL34_IST_003", cellId: 8003, cellName: "IST003_LTE_03", reason: "LTE_High_Utilized_Cell(Instagram)", date: "2023-07-12 18:10:26", lMax: 181, prb: 72, thrg: "60 Minutes", lat: 41.0234, lng: 28.9823 },
      { id: 4, oss_id: 1, disaster_event_id: 552293, cabName: "GL34_IST_004", cellId: 8004, cellName: "IST004_LTE_04", reason: "LTE_High_Utilized_Cell(YouTube)", date: "2023-07-12 18:15:26", lMax: 190, prb: 56, thrg: "60 Minutes", lat: 41.0145, lng: 28.9812 },
      { id: 5, oss_id: 1, disaster_event_id: 552293, cabName: "GL34_IST_005", cellId: 8005, cellName: "IST005_LTE_05", reason: "LTE_High_Utilized_Cell(Video)", date: "2023-07-12 18:20:26", lMax: 160, prb: 43, thrg: "30 Minutes", lat: 41.0198, lng: 28.9678 },
      { id: 6, oss_id: 1, disaster_event_id: 552293, cabName: "GL34_IST_006", cellId: 8006, cellName: "IST006_LTE_01", reason: "LTE_High_Utilized_Cell(Streaming)", date: "2023-10-19 02:00:41", lMax: 79, prb: 91, thrg: "60 Minutes", lat: 40.9876, lng: 29.3456 },
      { id: 7, oss_id: 1, disaster_event_id: 552293, cabName: "GL34_IST_007", cellId: 8007, cellName: "IST007_LTE_02", reason: "LTE_High_Utilized_Cell(Gaming)", date: "2023-10-19 02:10:41", lMax: 88, prb: 23, thrg: "60 Minutes", lat: 40.9934, lng: 29.3512 },
      { id: 100, oss_id: 1, disaster_event_id: 552293, cabName: "GL34_IST_100", cellId: 8100, cellName: "IST100_LTE_05", reason: "LTE_High_Utilized_Cell(Video)", date: "2023-11-16 15:40:25", lMax: 163, prb: 14, thrg: "60 Minutes", lat: 40.9612, lng: 29.0012 }
    ];

    // Harita ve katmanlar
    const map = L.map('map', { 
      center: [39.0, 35.0], 
      zoom: 6.5, 
      minZoom: 6.5,
      maxZoom: 16,
      preferCanvas: true 
    });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Selahattin AY'
    });

    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: ' Selahattin AY'
    }).addTo(map);

    const fixedNEsLayer = L.layerGroup().addTo(map);
    const disconnectedNEsLayer = L.layerGroup().addTo(map);
    let heatmapLayer = null;
    let utilizedMarkersLayer = null;
    let utilizedCellsData = [];

    function isValidCoord(lat, lng) {
      return isFinite(lat) && isFinite(lng);
    }

    function renderSites(data) {
      fixedNEsLayer.clearLayers();
      disconnectedNEsLayer.clearLayers();
      
      const fixedMarkers = [];
      const disconnectedMarkers = [];
      
      data.forEach(s => {
        const { Lat_Site: lat, Lon_Site: lng, cab_name, enabled_date } = s;
        if (!isValidCoord(+lat, +lng)) return;
        
        const isFixed = !!enabled_date;
        const fill = isFixed ? '#4caf50' : '#f44336';
        const popupContent = `<b>${cab_name}</b><br/>D√ºzelme: ${enabled_date || '-'}`;
        
        const marker = L.circleMarker([+lat, +lng], {
          radius: 3, 
          color: '#fff', 
          weight: 1, 
          fillColor: fill, 
          fillOpacity: 0.8,
          interactive: true, 
          bubblingMouseEvents: false, 
          pane: 'markerPane'
        }).bindPopup(popupContent);

        if (isFixed) {
          fixedMarkers.push(marker);
        } else {
          disconnectedMarkers.push(marker);
        }
      });
      
      // ‚úÖ Batch ekleme daha hƒ±zlƒ±
      fixedMarkers.forEach(m => m.addTo(fixedNEsLayer));
      disconnectedMarkers.forEach(m => m.addTo(disconnectedNEsLayer));
    }

    function renderHeatmap(utilCells) {
      if (!L.heatLayer) return;
      if (heatmapLayer) heatmapLayer.remove();
      if (utilizedMarkersLayer) utilizedMarkersLayer.remove();

      utilizedCellsData = utilCells;

      // PRB deƒüerlerini ƒ±sƒ±l harita i√ßin hazƒ±rla (0-1 arasƒ±nda normalize et)
      const heatData = utilCells
        .filter(uc => isValidCoord(+uc.lat, +uc.lng))
        .map(uc => [+uc.lat, +uc.lng, uc.prb / 100]);

      // Isƒ±l harita olu≈ütur
      if (heatData.length > 0) {
        heatmapLayer = L.heatLayer(heatData, {
          radius: 20,
          blur: 12,
          maxZoom: 8,
          max: 1,
          minOpacity: 0.5,
      gradient: {
            0.0: '#006400',     // DarkGreen
            0.2: '#00FF00',     // Green
            0.35: '#FFFF66',    // Light Yellow
            0.5: '#FFD700',     // Gold
            0.65: '#FF8C00',    // Dark Orange
            0.8: '#FF7F50',     // Coral
            0.9: '#FF0000',     // Red
            1.0: '#8B0000'      // DarkRed
        }
        }).addTo(map);
      }

      // Marker layer olu≈ütur (tƒ±klanabilirlik i√ßin)
      utilizedMarkersLayer = L.layerGroup();
      utilCells.forEach(uc => {
        const { lat, lng, cellName, cabName, cellId, reason, date, lMax, prb, thrg } = uc;
        if (!isValidCoord(+lat, +lng)) return;
        
        const marker = L.circleMarker([+lat, +lng], {
          radius: 4,
          color: 'transparent',
          weight: 0,
          fillColor: 'transparent',
          fillOpacity: 0,
          interactive: true,
          pane: 'markerPane'
        });

        marker.on('click', () => { 
          showDetailPanel(uc);
        });

        marker.bindPopup(`
          <b>${cellName}</b><br/>
          PRB: <strong>${prb}%</strong>
        `);

        marker.addTo(utilizedMarkersLayer);
      });
      
      utilizedMarkersLayer.addTo(map);
    }

    function getPRBClass(prb) {
      if (prb >= 80) return 'prb-high';
      if (prb >= 50) return 'prb-medium';
      return 'prb-low';
    }

    function showDetailPanel(cell) {
      const table = document.getElementById('detailTable');
      table.innerHTML = `
        <tr><td>üì± Cell Adƒ±:</td><td>${cell.cellName}</td></tr>
        <tr><td>üè¢ Saha Adƒ±:</td><td>${cell.cabName}</td></tr>
        <tr><td>üÜî Cell ID:</td><td>${cell.cellId}</td></tr>
        <tr><td>‚ö†Ô∏è Sebep:</td><td>${cell.reason}</td></tr>
        <tr><td>üìÖ Tarih:</td><td>${cell.date}</td></tr>
        <tr><td>üìä PRB:</td><td><span class="${getPRBClass(cell.prb)}">${cell.prb}%</span></td></tr>
        <tr><td>üìà lMax:</td><td>${cell.lMax}</td></tr>
        <tr><td>üìç Konum:</td><td>${(+cell.lat).toFixed(4)}, ${(+cell.lng).toFixed(4)}</td></tr>
      `;
      document.getElementById('detailPanel').classList.add('show');
      document.getElementById('searchResults').classList.remove('show');
    }

    function closeDetailPanel() {
      document.getElementById('detailPanel').classList.remove('show');
    }

    function closeSearchResults() {
      document.getElementById('searchResults').classList.remove('show');
    }

    function performSearch(query) {
      if (!query.trim()) {
        document.getElementById('searchResults').classList.remove('show');
        return;
      }

      const utilizedResults = utilizedCellsData.filter(cell => 
        cell.cellName.toLowerCase().includes(query.toLowerCase()) ||
        cell.cabName.toLowerCase().includes(query.toLowerCase()) ||
        cell.reason.toLowerCase().includes(query.toLowerCase())
      );

      const siteResults = siteStatuses.filter(site =>
        site.cab_name.toLowerCase().includes(query.toLowerCase())
      ).map(site => ({
        id: `site_${site.cab_name}`,
        cellName: site.cab_name,
        cabName: site.cab_name,
        cellId: '-',
        reason: site.enabled_date ? 'Aktif Saha (Fixed NE)' : 'ƒ∞naktif Saha (Disconnected NE)',
        date: site.enabled_date || '-',
        lMax: '-',
        prb: site.enabled_date ? 0 : 100,
        thrg: '-',
        lat: site.Lat_Site,
        lng: site.Lon_Site,
        isSite: true
      }));

      const allResults = [...utilizedResults, ...siteResults];
      const table = document.getElementById('resultsTable');
      
      if (allResults.length === 0) {
        table.innerHTML = '<tr><td colspan="2" class="no-results">Sonu√ß bulunamadƒ±</td></tr>';
        document.getElementById('searchResults').classList.add('show');
        return;
      }

      // ‚úÖ Fƒ∞X: Doƒüru ≈üekilde escape edilmi≈ü onclick handler
      table.innerHTML = allResults.slice(0, 20).map((cell, idx) => {
        const prbClass = getPRBClass(cell.prb);
        const statusText = cell.isSite 
          ? (cell.date !== '-' ? '‚úì Aktif' : '‚úó ƒ∞naktif')
          : `PRB: <span class="${prbClass}">${cell.prb}%</span>`;
        
        return `
          <tr class="clickable" data-index="${idx}" data-id="${cell.id}" data-lat="${cell.lat}" data-lng="${cell.lng}">
            <td>${escapeHtml(cell.cellName)}</td>
            <td>${escapeHtml(cell.cabName)} ‚Ä¢ ${statusText}</td>
          </tr>
        `;
      }).join('');

      // ‚úÖ Event delegation ile tƒ±klamalarƒ± y√∂net
      document.querySelectorAll('#resultsTable tr[data-id]').forEach(row => {
        row.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const lat = parseFloat(this.getAttribute('data-lat'));
          const lng = parseFloat(this.getAttribute('data-lng'));
          handleCellClick(id, lat, lng);
        });
      });

      document.getElementById('searchResults').classList.add('show');
    }

    // ‚úÖ HTML escape fonksiyonu
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    // ‚úÖ ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LMƒ∞≈û handleCellClick
    window.handleCellClick = function(id, lat, lng) {
      try {
        // Site mi yoksa h√ºcre mi kontrol et
        if (id.startsWith('site_')) {
          const cellName = id.replace('site_', '');
          const site = siteStatuses.find(s => s.cab_name === cellName);
          if (site) {
            map.setView([site.Lat_Site, site.Lon_Site], 14);
            const table = document.getElementById('detailTable');
            table.innerHTML = `
              <tr><td>üè¢ Saha Adƒ±:</td><td>${escapeHtml(site.cab_name)}</td></tr>
              <tr><td>üìä Durum:</td><td>${site.enabled_date ? '<span style="color: #4caf50; font-weight: bold;">‚úì Aktif</span>' : '<span style="color: #f44336; font-weight: bold;">‚úó ƒ∞naktif</span>'}</td></tr>
              <tr><td>üìÖ Etkinle≈ütirme Tarihi:</td><td>${site.enabled_date || 'Hen√ºz etkinle≈ütirilmedi'}</td></tr>
              <tr><td>üìç Latitude:</td><td>${(+site.Lat_Site).toFixed(6)}</td></tr>
              <tr><td>üìç Longitude:</td><td>${(+site.Lon_Site).toFixed(6)}</td></tr>
            `;
            document.getElementById('detailPanel').classList.add('show');
            document.getElementById('searchResults').classList.remove('show');
          }
        } else {
          // H√ºcre detay paneli
          const cell = utilizedCellsData.find(c => c.id == id);
          if (cell) {
            map.setView([lat, lng], 14);
            showDetailPanel(cell);
          }
        }
      } catch (error) {
        console.error('Hata:', error);
      }
    };

    // Event Listeners
    document.getElementById('searchInput').addEventListener('input', e => {
      performSearch(e.target.value);
    });

    document.getElementById('heatToggleInput').addEventListener('change', e => {
      if (e.target.checked && heatmapLayer) {
        heatmapLayer.addTo(map);
      } else if (!e.target.checked && heatmapLayer) {
        map.removeLayer(heatmapLayer);
      }
    });

    document.getElementById('fixedNEsToggle').addEventListener('change', e => {
      e.target.checked ? map.addLayer(fixedNEsLayer) : map.removeLayer(fixedNEsLayer);
    });

    document.getElementById('disconnectedNEsToggle').addEventListener('change', e => {
      e.target.checked ? map.addLayer(disconnectedNEsLayer) : map.removeLayer(disconnectedNEsLayer);
    });

    const layerToggleInputs = document.querySelectorAll('input[name="layerToggle"]');
    layerToggleInputs.forEach(input => {
      input.addEventListener('change', e => {
        const value = e.target.value;
        map.removeLayer(fixedNEsLayer);
        map.removeLayer(disconnectedNEsLayer);
        if (value === 'fixedNEs') {
          map.addLayer(fixedNEsLayer);
        } else if (value === 'disconnectedNEs') {
          map.addLayer(disconnectedNEsLayer);
        }
      });
    });

    const mapLayerInputs = document.querySelectorAll('input[name="mapLayer"]');
    mapLayerInputs.forEach(input => {
      input.addEventListener('change', e => {
        const value = e.target.value;
        if (value === 'osm') {
          map.addLayer(osm);
          map.removeLayer(esri);
        } else if (value === 'esri') {
          map.addLayer(esri);
          map.removeLayer(osm);
        }
      });
    });

    // Initialize
    renderSites(siteStatuses);
    renderHeatmap(utilizedCells);

    // Deprem Halkalarƒ±
    function renderEarthquakes(earthquakes) {
      earthquakes.forEach(eq => {
        const { latitude, longitude, magnitude, location, eventDate } = eq;
        if (!isValidCoord(+latitude, +longitude)) return;

        // B√ºy√ºkl√ºƒüe g√∂re renk belirle
        let color;
        if (magnitude < 4) color = 'green';
        else if (magnitude < 5) color = 'blue';
        else if (magnitude < 6) color = 'orange';
        else if (magnitude < 7) color = 'red';
        else color = 'purple';

        // Merkez noktasƒ± - weight 5 daire
        L.circleMarker([+latitude, +longitude], {
          radius: 3,
          color: color,
          weight: 1,
          fillColor: color,
          fillOpacity: 0.5,
          interactive: true,
          pane: 'markerPane'
        }).bindPopup(`
          <b>üåç Deprem</b><br/>
          <strong>${location}</strong><br/>
          ≈ûiddet: <strong>${magnitude}</strong><br/>
          Tarih: ${eventDate}<br/>
          Konum: ${(+latitude).toFixed(4)}, ${(+longitude).toFixed(4)}
        `).addTo(map);

        // Tek seviye animasyonlu geni≈üleyen halka
        function createWave(lat, lng, waveColor) {
          let currentRadius = 0;
          const maxRadius = 17000;
          const expandingCircle = L.circle([lat, lng], {
            color: "white",
            weight: 1,
            fillColor: waveColor,
            fillOpacity: 0.3,
            radius: currentRadius,
            interactive: false,
            pane: 'markerPane'
          }).addTo(map);

          // Animasyon d√∂ng√ºs√º
          const waveInterval = setInterval(() => {
            currentRadius += 600;
            if (currentRadius > maxRadius) {
              currentRadius = 0;
            }
            expandingCircle.setRadius(currentRadius);
          }, 50);

          // Haritadan kaldƒ±rƒ±ldƒ±ƒüƒ±nda animasyonu temizle
          expandingCircle.on('remove', () => {
            clearInterval(waveInterval);
          });
        }

        // Tek seviye halka olu≈ütur
        createWave(+latitude, +longitude, color);
      });
    }

    // Depremler haritaya ekle
    renderEarthquakes(earthquakesRaw);
  </script>
</body>
</html>
