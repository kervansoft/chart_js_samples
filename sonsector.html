<!DOCTYPE html>
<html>
<head>
    <title>Stacked Bar Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- jQuery kütüphanesi eklendi -->
</head>
<body>
    <canvas id="myChart"></canvas>

    <script>
        var data = []; // Boş veri dizisi ile başlayın
        var cabNames = [];
        var colorPalette = [];
        var datasets = [];

        // Cell gruplarını otomatik olarak bulma
        function findCellGroups(data) {
            var cellGroups = {};
            data.forEach(item => {
                var cellNum = item.CellName % 10; // CellName'in son hanesi
                if (!(cellNum in cellGroups)) {
                    cellGroups[cellNum] = [];
                }
                cellGroups[cellNum].push(item.CellName);
            });
            return Object.values(cellGroups);
        }

        // Renkleri yumuşak tonlarda ayarla
        function generateSoftColors(groups) {
            var colors = [];
            var lightnessStep = 70 / groups.length;
            for (var i = 0; i < groups.length; i++) {
                var lightness = 20 + lightnessStep * i;
                colors.push(`hsl(900, 70%, ${lightness}%)`);
            }
            return colors;
        }

        // Grafik oluşturma fonksiyonu
        function createChart(data) {
            cabNames = [...new Set(data.map(item => item.CabName))];
            colorPalette = generateSoftColors(cellGroups);

            datasets = [];
            cellGroups.forEach((group, index) => {
                var totalUsersData = [];
                cabNames.forEach(cabName => {
                    var filteredData = data.filter(item => group.includes(item.CellName) && item.CabName === cabName);
                    var totalUsers = filteredData.length > 0 ? filteredData.reduce((sum, item) => sum + item.TotalUsers, 0) : 0;
                    totalUsersData.push(totalUsers);
                });

                datasets.push({
                    label: `Sector ${index + 1}`,
                    data: totalUsersData,
                    backgroundColor: colorPalette[index]
                });
            });

            var ctx = document.getElementById("myChart").getContext("2d");
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: cabNames.map(String),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: "top"
                        },
                        title: {
                            display: true,
                            text: "mnute"
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: "CabName"
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: "TotalUsers"
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            $.ajax({
                type: "GET",
                url: "/eventgrafikcell/" + event_id, 
                data: {
                    id: event_id,
                    _token: csrf
                },
                success: function(response) {
                    createChart(response);
                }
            });
        }

        $(document).ready(function() {
            updateChart(); // Sayfa yüklendiğinde grafik oluştur
            setInterval(updateChart, 60000); // 1 dakikada bir grafik güncelle
        });
    </script>
</body>
</html>
